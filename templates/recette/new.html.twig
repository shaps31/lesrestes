{% extends 'base.html.twig' %}

{% block title %}Publier une nouvelle recette - Les Restes{% endblock %}

{% block body %}
<div class="container">
    <!-- Header avec retour -->
    <div class="mb-4">
        <a href="{{ path('app_profil') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour à mon profil
        </a>
    </div>
    
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h2 class="mb-4">Publier une nouvelle recette</h2>
            
            {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}
            
            <!-- Titre -->
            <div class="mb-3">
                <label for="recette_nom" class="form-label">
                    Titre <span class="text-danger">*</span>
                </label>
                {{ form_widget(form.nom, {'attr': {'class': 'form-control', 'placeholder': 'Omelette anti-gaspi'}}) }}
                {{ form_errors(form.nom) }}
            </div>
            
            <!-- Description -->
            <div class="mb-3">
                <label for="recette_description" class="form-label">
                    Description <span class="text-danger">*</span>
                </label>
                {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4, 'placeholder': 'Une recette pour utiliser vos restes de légumes...'}}) }}
                {{ form_errors(form.description) }}
            </div>
            
           <!-- Upload image -->
            <div class="mb-3">
                {{ form_label(form.imageFile, 'Image de la recette', {'label_attr': {'class': 'form-label'}}) }}
                <div class="border rounded p-3 bg-light">
                    {{ form_widget(form.imageFile, {'attr': {'class': 'form-control', 'accept': 'image/*'}}) }}
                    {{ form_errors(form.imageFile) }}
                    <small class="form-text text-muted mt-2">
                        Formats acceptés : JPG, PNG, GIF. Taille max : 5MB
                    </small>
                </div>
            </div>
            
            <!-- Temps de préparation -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="recette_tempsCuisson" class="form-label">Temps de préparation</label>
                    <div class="input-group">
                        {{ form_widget(form.tempsCuisson, {'attr': {'class': 'form-control', 'value': '15'}}) }}
                        <span class="input-group-text">minutes</span>
                    </div>
                    {{ form_errors(form.tempsCuisson) }}
                </div>
                
                <!-- Nombre de personnes -->
                <div class="col-md-6">
                    <label for="recette_nombrePersonnes" class="form-label">Nombre de personnes</label>
                    {{ form_widget(form.nombrePersonnes, {'attr': {'class': 'form-control', 'value': '4'}}) }}
                    {{ form_errors(form.nombrePersonnes) }}
                </div>
            </div>
            
            <!-- Difficulté -->
            <div class="mb-4">
                <label class="form-label">Difficulté</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="recette[difficulte]" id="facile" value="1" checked>
                        <label class="form-check-label" for="facile">Facile</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="recette[difficulte]" id="moyen" value="2">
                        <label class="form-check-label" for="moyen">Moyen</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="recette[difficulte]" id="difficile" value="3">
                        <label class="form-check-label" for="difficile">Difficile</label>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Ingrédients dynamiques -->
            <h5 class="mb-3">Ingrédients</h5>
            <div id="ingredients-collection" class="mb-3" 
                 data-prototype="{{ form_widget(form.recetteIngredients.vars.prototype)|e('html_attr') }}">
    
            {% for recetteIngredient in form.recetteIngredients %}
                <div class="ingredient-row border rounded p-2 mb-2">
                    <div class="row">
                        <div class="col-md-4">
                            <!-- Champ caché pour l'ID -->
                            {{ form_widget(recetteIngredient.ingredient_id) }}
                            <!-- Champ texte pour le nom avec autocomplete -->
                            {{ form_widget(recetteIngredient.ingredient_nom, {
                        'attr': {'class': 'form-control form-control-sm ingredient-autocomplete'}
                    }) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_widget(recetteIngredient.quantite, {
                                'attr': {'class': 'form-control form-control-sm'}
                            }) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_widget(recetteIngredient.unite, {
                                'attr': {'class': 'form-select form-select-sm'}
                            }) }}
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>

            <button type="button" class="btn btn-outline-success btn-sm mb-4" id="add-ingredient">
                <i class="bi bi-plus"></i> Ajouter un ingrédient
            </button>
            <hr class="my-4">
            
            <!-- Étapes de préparation -->
            <h5 class="mb-3">Étapes de préparation</h5>
            {{ form_widget(form.etapes, {'attr': {'class': 'form-control', 'rows': 8, 'placeholder': "1. Battre les œufs dans un bol\n2. Couper les tomates en dés\n3. Faire revenir l'oignon...\n4. Ajouter les œufs battus\n5. Servir chaud"}}) }}
            {{ form_errors(form.etapes) }}
            
            <small class="form-text text-muted mb-3 d-block">
                Saisissez chaque étape sur une ligne séparée, numérotée.
            </small>
            
            <!-- Catégorie -->
            <div class="mb-4">
                <label class="form-label">Catégorie</label>
                {{ form_widget(form.categorie, {'attr': {'class': 'form-select'}}) }}
                {{ form_errors(form.categorie) }}
            </div>
            
            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between">
                <a href="{{ path('app_recette_index') }}" class="btn btn-outline-secondary">
                    Annuler
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Publier la recette
                </button>
            </div>
            
            {{ form_end(form) }}
        </div>
    </div>
</div>

<style>
.ingredient-row .row > div {
    padding-left: 5px;
    padding-right: 5px;
}

.ingredient-row {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.ingredient-row:hover {
    background-color: #e9ecef;
}

.remove-ingredient {
    width: 100%;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsContainer = document.getElementById('ingredients-collection');
    const addButton = document.getElementById('add-ingredient');
    let index = 0;
    
    // Fonction pour transformer un select en autocomplete
    function setupAutocomplete(selectElement) {
        // Cacher le select original
        selectElement.style.display = 'none';
        
        // Créer l'input de recherche
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control form-control-sm';
        searchInput.placeholder = 'Tapez pour rechercher...';
        searchInput.autocomplete = 'off';
        
        // Conteneur pour les résultats
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'autocomplete-results position-absolute bg-white border rounded shadow-sm';
        resultsDiv.style.cssText = 'top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; display: none;';
        
        // Insérer après le select
        selectElement.parentElement.style.position = 'relative';
        selectElement.parentElement.appendChild(searchInput);
        selectElement.parentElement.appendChild(resultsDiv);
        
        let timeoutId;
        
        // Recherche avec debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            const query = this.value.trim();
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            timeoutId = setTimeout(() => {
                fetch(`/api/ingredients/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(ingredients => {
                        resultsDiv.innerHTML = '';
                        
                        if (ingredients.length === 0) {
                            resultsDiv.style.display = 'none';
                            return;
                        }
                        
                        ingredients.forEach(ingredient => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item p-2 border-bottom';
                            item.style.cursor = 'pointer';
                            item.textContent = ingredient.nom;
                            
                            item.addEventListener('mouseenter', () => item.classList.add('bg-light'));
                            item.addEventListener('mouseleave', () => item.classList.remove('bg-light'));
                            
                            item.addEventListener('click', () => {
                                searchInput.value = ingredient.nom;
                                selectElement.value = ingredient.id;
                                resultsDiv.style.display = 'none';
                            });
                            
                            resultsDiv.appendChild(item);
                        });
                        
                        resultsDiv.style.display = 'block';
                    })
                    .catch(error => console.error('Erreur autocomplete:', error));
            }, 300);
        });
        
        // Fermer en cliquant ailleurs
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }
    
    // Ajouter un ingrédient
    addButton.addEventListener('click', function() {
        const prototype = ingredientsContainer.dataset.prototype;
        const newForm = prototype.replace(/__name__/g, index);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newForm;
        
        const ingredientSelect = tempDiv.querySelector('select[name*="ingredient"]');
        const quantiteInput = tempDiv.querySelector('input[name*="quantite"]');
        const uniteSelect = tempDiv.querySelector('select[name*="unite"]');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'ingredient-row border rounded p-2 mb-2';
        wrapper.innerHTML = `
            <div class="row">
                <div class="col-md-4 ingredient-field"></div>
                <div class="col-md-3 quantite-field"></div>
                <div class="col-md-3 unite-field"></div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `;
        
        if (ingredientSelect) {
            wrapper.querySelector('.ingredient-field').appendChild(ingredientSelect);
            setupAutocomplete(ingredientSelect);
        }
        
        if (quantiteInput) {
            quantiteInput.className = 'form-control form-control-sm';
            wrapper.querySelector('.quantite-field').appendChild(quantiteInput);
        }
        
        if (uniteSelect) {
            uniteSelect.className = 'form-select form-select-sm';
            wrapper.querySelector('.unite-field').appendChild(uniteSelect);
        }
        
        ingredientsContainer.appendChild(wrapper);
        index++;
        
        wrapper.querySelector('.remove-ingredient').addEventListener('click', function() {
            wrapper.remove();
        });
    });
});
</script>
{% endblock %}