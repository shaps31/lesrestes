{% extends 'base.html.twig' %}

{% block title %}{{ recette.nom }} - Les Restes{% endblock %}

{% block body %}
<div class="container">
    <!-- Header avec retour et favoris -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ path('app_recette_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
        {% if app.user %}
            <button class="btn btn-outline-danger{{ isFavorite ? ' text-danger' : '' }}" id="favoriBtn">
                <i class="bi bi-heart{{ isFavorite ? '-fill' : '' }}"></i> Favoris
            </button>
        {% endif %}
    </div>
    
    <!-- Grande photo recette -->
    <div class="text-center mb-4">
        {% if recette.image %}
            <img src="/uploads/recettes/{{ recette.image }}" 
                 class="img-fluid rounded shadow" 
                 alt="{{ recette.nom }}" 
                 style="max-height: 400px; width: 100%; object-fit: cover;">
        {% else %}
            <img src="https://source.unsplash.com/800x400/?food" 
                 class="img-fluid rounded shadow" 
                 alt="{{ recette.nom }}" 
                 style="max-height: 400px; width: 100%; object-fit: cover;">
        {% endif %}
    </div>
    
    <!-- Informations principales -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="mb-2">{{ recette.nom }}</h1>
            <p class="text-muted mb-3">
                Par {{ recette.user.prenom }} {{ recette.user.nom }} - 
                {{ recette.dateCreation|date('d M Y') }}
            </p>
            
            <!-- Notes et avis -->
            <div class="mb-3">
                {% if recette.commentaires|length > 0 %}
                    {% set moyenne = recette.moyenneNotes %}
                    <span class="me-2">
                        {% for i in 1..5 %}
                            {% if i <= moyenne %}
                                <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-star text-muted"></i>
                            {% endif %}
                        {% endfor %}
                    </span>
                    <span class="text-muted">({{ recette.commentaires|length }} avis)</span>
                    <span class="ms-2 fw-bold text-warning">{{ moyenne }}/5</span>
                {% else %}
                    <span class="text-muted">Aucun avis pour le moment</span>
                {% endif %}
            </div>
            
            <!-- Infos rapides avec icônes -->
            <div class="row text-center mb-4">
                <div class="col-4">
                    <div class="border rounded p-3">
                        <i class="bi bi-clock text-primary fs-4"></i>
                        <div class="mt-2">{{ recette.tempsCuisson }} min</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-3">
                        <i class="bi bi-person-gear text-success fs-4"></i>
                        <div class="mt-2">
                            {% if recette.difficulte == 1 %}Facile
                            {% elseif recette.difficulte == 2 %}Moyen
                            {% else %}Difficile{% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="border rounded p-3">
                        <i class="bi bi-people text-warning fs-4"></i>
                        <div class="mt-2">{{ recette.nombrePersonnes }} pers.</div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Ingrédients avec checkboxes -->
            <h4 class="mb-3">
                <i class="bi bi-basket"></i> Ingrédients
            </h4>
            <div class="mb-4">
                {% if recette.recetteIngredients|length > 0 %}
                    {% for recetteIngredient in recette.recetteIngredients %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="ingredient{{ loop.index }}">
                            <label class="form-check-label" for="ingredient{{ loop.index }}">
                                {{ recetteIngredient.quantite }} {{ recetteIngredient.unite }} {{ recetteIngredient.ingredient.nom }}
                            </label>
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- Ingrédients temporaires en attendant les vraies données -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="ingredient1">
                        <label class="form-check-label" for="ingredient1">3 œufs</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="ingredient2">
                        <label class="form-check-label" for="ingredient2">2 tomates</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="ingredient3">
                        <label class="form-check-label" for="ingredient3">1 oignon</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="ingredient4">
                        <label class="form-check-label" for="ingredient4">Sel, poivre</label>
                    </div>
                {% endif %}
            </div>
            
            <hr class="my-4">
            
            <!-- Préparation -->
            <h4 class="mb-3">
                <i class="bi bi-list-ol"></i> Préparation
            </h4>
            <div class="mb-4">
                {% if recette.etapes %}
                    {% set etapes = recette.etapes|split('\n') %}
                    <ol>
                        {% for etape in etapes %}
                            {% if etape|trim %}
                                <li class="mb-2">{{ etape|trim }}</li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                {% endif %}
            </div>
            
            <hr class="my-4">
            
            <!-- Commentaires -->
            <h4 class="mb-3">
                <i class="bi bi-chat-dots"></i> Commentaires ({{ recette.commentaires|length }})
            </h4>
            
            {% if app.user %}
                <!-- Formulaire d'avis -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Laisser un avis</h6>
                        {{ form_start(commentaireForm) }}
                            <!-- Note avec étoiles personnalisées -->
                            <div class="mb-3">
                                <label class="form-label">Note :</label>
                                <div class="star-rating">
                                    {% for i in 1..5 %}
                                        <input type="radio" name="commentaire[note]" value="{{ i }}" id="star{{ i }}" class="star-input">
                                        <label for="star{{ i }}" class="star-label">
                                            <i class="bi bi-star"></i>
                                        </label>
                                    {% endfor %}
                                </div>
                                {{ form_errors(commentaireForm.note) }}
                            </div>
                            
                            {{ form_row(commentaireForm.contenu) }}
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send"></i> Publier l'avis
                            </button>
                            
                            <!-- Cacher le widget original -->
                            <div style="display: none;">
                                {{ form_widget(commentaireForm.note) }}
                            </div>
                        {{ form_end(commentaireForm) }}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <a href="{{ path('app_login') }}">Connectez-vous</a> pour laisser un commentaire.
                </div>
            {% endif %}
            
            <!-- Liste des commentaires -->
            {% if recette.commentaires|length > 0 %}
                {% for commentaire in recette.commentaires %}
                    <div class="border-start border-3 border-success ps-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ commentaire.user.prenom }} {{ commentaire.user.nom }}</strong>
                    <small class="text-muted ms-2">{{ commentaire.dateCreation|date('d M Y') }}</small>
                </div>
                
                <!-- Bouton supprimer si c'est son propre commentaire -->
                {% if app.user and commentaire.user == app.user %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <button class="dropdown-item text-danger" onclick="confirmerSuppressionCommentaire({{ commentaire.id }})">
                                    <i class="bi bi-trash"></i> Supprimer
                                </button>
                            </li>
                        </ul>
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-1">
                {% for i in 1..5 %}
                    {% if i <= commentaire.note %}
                        <i class="bi bi-star-fill text-warning"></i>
                    {% else %}
                        <i class="bi bi-star text-muted"></i>
                    {% endif %}
                {% endfor %}
            </div>
            <p class="mb-0">{{ commentaire.contenu }}</p>
        </div>
    {% endfor %}
{% else %}
    <p class="text-muted">Aucun commentaire pour le moment. Soyez le premier à donner votre avis !</p>
{% endif %}
        </div>
    </div>
</div>
</div>

<!-- Modal de confirmation suppression commentaire -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer le commentaire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce commentaire ?</p>
                <p class="text-warning small">Cette action est irréversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form method="post" id="deleteCommentForm" style="display: inline;">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete') }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<style>
.star-rating {
    display: flex;
    justify-content: flex-start;
}

.star-input {
    display: none;
}

.star-label {
    cursor: pointer;
    font-size: 1.5rem;
    color: #ddd;
    transition: color 0.2s;
    margin: 0 2px;
}

.star-label.active {
    color: #ffc107;
}
</style>

<script>
// Script amélioré pour les étoiles
document.addEventListener('DOMContentLoaded', function() {
    const starInputs = document.querySelectorAll('.star-input');
    const starLabels = document.querySelectorAll('.star-label');
    
    // Fonction pour mettre à jour l'affichage des étoiles
    function updateStars(rating) {
        starLabels.forEach((label, index) => {
            if (index < rating) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }
    
    // Ajouter les événements sur chaque étoile
    starLabels.forEach((label, index) => {
        // Survol
        label.addEventListener('mouseenter', function() {
            updateStars(index + 1);
        });
        
        // Clic
        label.addEventListener('click', function() {
            const rating = index + 1;
            
            // Cocher l'input correspondant
            starInputs[index].checked = true;
            
            // Synchroniser avec le champ Symfony caché
            const hiddenInputs = document.querySelectorAll('input[name="commentaire[note]"]:not(.star-input)');
            hiddenInputs.forEach(input => {
                input.checked = (input.value == rating);
            });
            
            // Maintenir l'affichage après le clic
            updateStars(rating);
            
            // Marquer comme sélectionné
            label.closest('.star-rating').setAttribute('data-rating', rating);
        });
    });
    
    // Gérer le survol - revenir à la sélection si il y en a une
    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
        const currentRating = this.getAttribute('data-rating');
        if (currentRating) {
            updateStars(parseInt(currentRating));
        } else {
            updateStars(0);
        }
    });
});

// Script pour les favoris (inchangé)
async function toggleFavori(recetteId, button) {
    try {
        const response = await fetch(`/api/favori/toggle/${recetteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const icon = button.querySelector('i');
            if (data.isFavorite) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                button.classList.add('text-danger');
            } else {
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                button.classList.remove('text-danger');
            }
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
}

document.getElementById('favoriBtn').addEventListener('click', function() {
    const recetteId = window.location.pathname.split('/').pop();
    toggleFavori(recetteId, this);
});
// Fonction pour confirmer la suppression d'un commentaire
function confirmerSuppressionCommentaire(commentaireId) {
    document.getElementById('deleteCommentForm').action = '/commentaire/' + commentaireId + '/delete';
    new bootstrap.Modal(document.getElementById('deleteCommentModal')).show();
}
</script>

{% endblock %}