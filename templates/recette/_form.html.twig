{{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

<!-- Titre -->
<div class="mb-3">
    {{ form_label(form.nom, 'Titre', {'label_attr': {'class': 'form-label'}}) }}
    <span class="text-danger">*</span>
    {{ form_widget(form.nom, {'attr': {'class': 'form-control', 'placeholder': 'Omelette anti-gaspi'}}) }}
    {{ form_errors(form.nom) }}
</div>

<!-- Description -->
<div class="mb-3">
    {{ form_label(form.description, 'Description', {'label_attr': {'class': 'form-label'}}) }}
    <span class="text-danger">*</span>
    {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4, 'placeholder': 'Une recette pour utiliser vos restes de légumes...'}}) }}
    {{ form_errors(form.description) }}
</div>

<!-- Upload image avec prévisualisation compacte -->
<div class="mb-3">
    {{ form_label(form.imageFile, 'Image de la recette', {'label_attr': {'class': 'form-label'}}) }}
    
    <!-- Prévisualisation compacte -->
    {% if recette.image %}
        <div class="d-flex align-items-center gap-3 p-3 mb-2 bg-light rounded border">
            <img src="/uploads/recettes/{{ recette.image }}" 
                 class="rounded shadow-sm" 
                 style="max-height: 80px; max-width: 120px; object-fit: cover;" 
                 alt="{{ recette.nom }}">
            <div class="flex-grow-1">
                <p class="mb-0 small text-success fw-bold">
                    <i class="bi bi-check-circle-fill"></i> Image actuelle
                </p>
                <p class="mb-0 small text-muted">
                    Pour la remplacer, sélectionnez une nouvelle image ci-dessous
                </p>
            </div>
        </div>
    {% endif %}
    
    <!-- Champ d'upload -->
    <div class="border rounded p-3 bg-white">
        {# Afficher le champ file de VichUploader #}
        {{ form_row(form.imageFile.file, {
            'label': false,
            'attr': {'class': 'form-control', 'accept': 'image/*'}
        }) }}
        
        {# Checkbox pour supprimer l'image si elle existe #}
        {% if recette.image and form.imageFile.delete is defined %}
            <div class="form-check mt-2">
                {{ form_widget(form.imageFile.delete, {'attr': {'class': 'form-check-input'}}) }}
                {{ form_label(form.imageFile.delete, 'Supprimer l\'image actuelle', {'label_attr': {'class': 'form-check-label text-danger'}}) }}
            </div>
        {% endif %}
        
        {{ form_errors(form.imageFile) }}
        <small class="form-text text-muted mt-2 d-block">
            <i class="bi bi-info-circle"></i>
            Formats acceptés : JPG, PNG, GIF. Taille max : 5MB
        </small>
    </div>
</div>

<!-- Temps et personnes -->
<div class="row mb-3">
    <div class="col-md-6">
        {{ form_label(form.tempsCuisson, 'Temps de préparation', {'label_attr': {'class': 'form-label'}}) }}
        <div class="input-group">
            {{ form_widget(form.tempsCuisson, {'attr': {'class': 'form-control'}}) }}
            <span class="input-group-text">minutes</span>
        </div>
        {{ form_errors(form.tempsCuisson) }}
    </div>
    
    <div class="col-md-6">
        {{ form_label(form.nombrePersonnes, 'Nombre de personnes', {'label_attr': {'class': 'form-label'}}) }}
        {{ form_widget(form.nombrePersonnes, {'attr': {'class': 'form-control'}}) }}
        {{ form_errors(form.nombrePersonnes) }}
    </div>
</div>

<!-- Difficulté -->
<div class="mb-3">
    {{ form_label(form.difficulte, 'Difficulté', {'label_attr': {'class': 'form-label'}}) }}
    {{ form_widget(form.difficulte, {'attr': {'class': 'form-select'}}) }}
    {{ form_errors(form.difficulte) }}
</div>

<!-- Ingrédients dynamiques -->
<h5 class="mb-3">Ingrédients</h5>
<div id="ingredients-collection" class="mb-3" 
     data-prototype="{{ form_widget(form.recetteIngredients.vars.prototype)|e('html_attr') }}">
    
    {% for recetteIngredient in form.recetteIngredients %}
        <div class="ingredient-row border rounded p-2 mb-2">
            <div class="row">
                <div class="col-md-4">
                    {{ form_widget(recetteIngredient.ingredient, {
                        'attr': {'class': 'form-select form-select-sm'}
                    }) }}
                </div>
                <div class="col-md-3">
                    {{ form_widget(recetteIngredient.quantite, {
                        'attr': {'class': 'form-control form-control-sm'}
                    }) }}
                </div>
                <div class="col-md-3">
                    {{ form_widget(recetteIngredient.unite, {
                        'attr': {'class': 'form-select form-select-sm'}
                    }) }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<button type="button" class="btn btn-outline-success btn-sm mb-4" id="add-ingredient">
    <i class="bi bi-plus"></i> Ajouter un ingrédient
</button>

<!-- Étapes -->
<div class="mb-3">
    {{ form_label(form.etapes, 'Étapes de préparation', {'label_attr': {'class': 'form-label'}}) }}
    {{ form_widget(form.etapes, {'attr': {'class': 'form-control', 'rows': 8, 'placeholder': "1. Battre les œufs dans un bol\n2. Couper les tomates en dés\n3. Faire revenir l'oignon..."}}) }}
    {{ form_errors(form.etapes) }}
    <small class="form-text text-muted">
        Saisissez chaque étape sur une ligne séparée, numérotée.
    </small>
</div>

<!-- Catégorie -->
<div class="mb-4">
    {{ form_label(form.categorie, 'Catégorie', {'label_attr': {'class': 'form-label'}}) }}
    {{ form_widget(form.categorie, {'attr': {'class': 'form-select'}}) }}
    {{ form_errors(form.categorie) }}
</div>

<!-- Boutons -->
<div class="d-flex justify-content-between">
    <a href="{{ path('app_recette_index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-x-circle"></i> Annuler
    </a>
    <button type="submit" class="btn btn-success">
        <i class="bi bi-check-circle"></i> {{ button_label|default('Enregistrer') }}
    </button>
</div>

{{ form_end(form) }}

<style>
.autocomplete-loading {
    position: relative;
}

.autocomplete-loading::after {
    content: '';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

.ingredient-row {
    transition: all 0.3s ease;
    transform: translateY(0);
}

.ingredient-row.adding {
    animation: slideInDown 0.4s ease;
}

.ingredient-row.removing {
    animation: slideOutUp 0.3s ease forwards;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

.autocomplete-results {
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ingredientsContainer = document.getElementById('ingredients-collection');
    const addButton = document.getElementById('add-ingredient');
    let index = 0;
    
    function setupAutocomplete(selectElement) {
        selectElement.style.display = 'none';
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control form-control-sm';
        searchInput.placeholder = 'Tapez pour rechercher...';
        searchInput.autocomplete = 'off';
        
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'autocomplete-results position-absolute bg-white border rounded shadow-sm';
        resultsDiv.style.cssText = 'top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; display: none;';
        
        selectElement.parentElement.style.position = 'relative';
        selectElement.parentElement.appendChild(searchInput);
        selectElement.parentElement.appendChild(resultsDiv);
        
        let timeoutId;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            const query = this.value.trim();
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                searchInput.classList.remove('autocomplete-loading');
                return;
            }
            
            // Afficher le loading
            searchInput.classList.add('autocomplete-loading');
            
            timeoutId = setTimeout(() => {
                fetch(`/api/ingredients/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(ingredients => {
                        searchInput.classList.remove('autocomplete-loading');
                        resultsDiv.innerHTML = '';
                        
                        if (ingredients.length === 0) {
                            resultsDiv.innerHTML = '<div class="p-2 text-muted">Aucun ingrédient trouvé</div>';
                            resultsDiv.style.display = 'block';
                            return;
                        }
                        
                        ingredients.forEach(ingredient => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item p-2 border-bottom';
                            item.style.cursor = 'pointer';
                            item.innerHTML = `
                                <strong>${ingredient.nom}</strong>
                                <small class="text-muted d-block">Unité par défaut: ${ingredient.unite}</small>
                            `;
                            
                            item.addEventListener('mouseenter', () => item.classList.add('bg-light'));
                            item.addEventListener('mouseleave', () => item.classList.remove('bg-light'));
                            
                            item.addEventListener('click', () => {
                                searchInput.value = ingredient.nom;
                                selectElement.value = ingredient.id;
                                resultsDiv.style.display = 'none';
                                
                                // Animation de validation
                                searchInput.style.borderColor = '#28a745';
                                setTimeout(() => {
                                    searchInput.style.borderColor = '';
                                }, 1000);
                            });
                            
                            resultsDiv.appendChild(item);
                        });
                        
                        resultsDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Erreur autocomplete:', error);
                        searchInput.classList.remove('autocomplete-loading');
                        resultsDiv.innerHTML = '<div class="p-2 text-danger">Erreur de recherche</div>';
                        resultsDiv.style.display = 'block';
                    });
            }, 300);
        });
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });
    }
    
    // Ajout animé d'ingrédient
    addButton.addEventListener('click', function() {
        const prototype = ingredientsContainer.dataset.prototype;
        const newForm = prototype.replace(/__name__/g, index);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newForm;
        
        const ingredientSelect = tempDiv.querySelector('select[name*="ingredient"]');
        const quantiteInput = tempDiv.querySelector('input[name*="quantite"]');
        const uniteSelect = tempDiv.querySelector('select[name*="unite"]');
        
        const wrapper = document.createElement('div');
        wrapper.className = 'ingredient-row border rounded p-2 mb-2 adding';
        wrapper.innerHTML = `
            <div class="row">
                <div class="col-md-4 ingredient-field"></div>
                <div class="col-md-3 quantite-field"></div>
                <div class="col-md-3 unite-field"></div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-ingredient w-100">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `;
        
        if (ingredientSelect) {
            wrapper.querySelector('.ingredient-field').appendChild(ingredientSelect);
            setupAutocomplete(ingredientSelect);
        }
        
        if (quantiteInput) {
            quantiteInput.className = 'form-control form-control-sm';
            wrapper.querySelector('.quantite-field').appendChild(quantiteInput);
        }
        
        if (uniteSelect) {
            uniteSelect.className = 'form-select form-select-sm';
            wrapper.querySelector('.unite-field').appendChild(uniteSelect);
        }
        
        ingredientsContainer.appendChild(wrapper);
        
        // Retirer la classe d'animation après
        setTimeout(() => wrapper.classList.remove('adding'), 400);
        
        index++;
        
        wrapper.querySelector('.remove-ingredient').addEventListener('click', function() {
            wrapper.classList.add('removing');
            setTimeout(() => wrapper.remove(), 300);
        });
    });
});
</script>